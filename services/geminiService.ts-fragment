// Using dbUnifiedData format for filtering
// We don't need new inputs as we are filtering existing data

export const generateDynamicCategoryQuery = async (availableGenres: string[]): Promise<any> => {
    try {
        const client = getAiClient();
        if (!client) throw new Error("No API Key");

        // We give the AI the current context (genres, time of day)
        const hour = new Date().getHours();
        const timeOfDay = hour < 12 ? 'morning' : hour < 18 ? 'afternoon' : 'night';

        const prompt = `
            You are a music curator for a personal dashboard.
            Your goal is to invent a creative, specific chart category based on a filter criteria.
            The user has a database of listening history.
            
            Current context:
            - Time of day: ${timeOfDay}
            - Available Genres in library: ${availableGenres.join(', ')}
            
            Generate a JSON object defining a creative category and how to filter for it.
            
            Constraint:
            - "filterType" must be one of: "time", "genre", "keyword".
            - If "filterType" is "time", provide "startHour" and "endHour" (0-23).
            - If "filterType" is "genre", provide "genreKeyword" (string).
            - If "filterType" is "keyword", provide "keyword" (to match in track/artist name).
            
            Return JSON only:
            {
                "title": "Creative Category Title (e.g. Late Night Vibes)",
                "description": "Short description (e.g. Tracks played after midnight)",
                "filterType": "time",
                "filterParams": { "startHour": 0, "endHour": 4 }
            }
        `;

        const response = await client.chat.completions.create({
            model: "llama-3.3-70b-versatile",
            messages: [{ role: "user", content: prompt }],
            response_format: { type: "json_object" },
            temperature: 0.9 // High creativity
        });

        const text = response.choices[0]?.message?.content || "{}";
        return JSON.parse(text);

    } catch (e) {
        console.error("AI Category Gen Error:", e);
        // Fallback
        return {
            title: "Focus Flow",
            description: "Generated by fallback",
            filterType: "keyword", // simple fallback
            filterParams: { keyword: "e" } // matches almost everything as fallback
        };
    }
}
